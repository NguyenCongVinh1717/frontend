<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Trang Gi√°o vi√™n</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
/* teacher-modern-v2.css - Hi·ªán ƒë·∫°i, s·∫°ch s·∫Ω, tinh t·∫ø h∆°n */

:root{
  /* M√†u s·∫Øc m·ªõi */
  --accent: #2196F3; /* Xanh Lam t∆∞∆°i m·ªõi (Material Blue 500) */
  --accent-dark: #1976D2; /* Xanh Lam ƒë·∫≠m h∆°n cho hover/active */
  --accent-light: #E3F2FD; /* N·ªÅn nh·∫π c·ªßa accent (Blue 50) */
  --bg: #f8f9fa; /* N·ªÅn t·ªïng th·ªÉ r·∫•t nh·∫π */
  --card: #ffffff;
  --text: #343a40; /* VƒÉn b·∫£n ƒë·∫≠m, d·ªÖ ƒë·ªçc (Dark Gray) */
  --muted: #6c757d; /* M√†u x√°m d·ªãu */
  --radius: 10px; /* Bo g√≥c nh·∫•t qu√°n, m·ªÅm m·∫°i h∆°n */
  --shadow: 0 6px 16px rgba(0,0,0,0.08); /* B√≥ng ƒë·ªï n·ªïi b·∫≠t h∆°n */
  --transition: 300ms cubic-bezier(0.4, 0, 0.2, 1);
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:'Poppins',sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  min-height:100vh;
  overflow-x:hidden;
  font-size:16px; /* C·ª° ch·ªØ l·ªõn h∆°n m·ªôt ch√∫t */
  line-height:1.6;
}
a, button{touch-action:manipulation;text-decoration:none}
:focus{outline:none}
:focus-visible{outline:2px solid var(--accent);outline-offset:2px;outline-color:rgba(33,150,243,0.5)}

/* --- SIDEBAR --- */
.sidebar{
  width:260px; /* R·ªông h∆°n m·ªôt ch√∫t */
  background:var(--card);
  padding:30px 20px;
  position:fixed;
  left:0;top:0;bottom:0;
  box-shadow:var(--shadow);
  z-index:1000;
  display:flex; /* Th√™m ƒë·ªÉ h·ªó tr·ª£ flex column */
  flex-direction:column;
}
.sidebar h4{
  color:var(--accent);
  font-weight:700;
  text-align:left;
  margin-bottom:40px;
  letter-spacing:0.8px;
  font-size:1.6em;
  display:flex;
  align-items:center;
  gap:8px;
}
.sidebar a{
  display:flex;
  align-items:center;
  gap:15px;
  padding:14px 18px; /* Padding l·ªõn h∆°n */
  color:var(--text); /* M√†u text m·∫∑c ƒë·ªãnh */
  border-radius:var(--radius);
  margin:4px 0;
  transition:all var(--transition);
  font-weight:500;
}
.sidebar a i{font-size:1.2em}
.sidebar a:hover{
  background:var(--accent-light);
  color:var(--accent-dark);
}
.sidebar a.active{
  background:var(--accent-light);
  color:var(--accent-dark);
  font-weight:600;
  border-left:5px solid var(--accent); /* Vi·ªÅn ƒë·∫≠m h∆°n */
  padding-left:17px; /* C√¢n b·∫±ng l·∫°i padding */
}

/* --- MAIN --- */
.main-content{margin-left:260px;padding:35px;flex:1}

/* --- HEADER --- */
.header{
  background:var(--card);
  padding:24px 30px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  margin-bottom:35px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-left:5px solid var(--accent); /* ƒêi·ªÉm nh·∫•n */
}
.header h3{font-size:28px;margin:0;color:var(--text);font-weight:700}
.header span{color:var(--accent);font-weight:700}

/* --- CONTENT --- */
.content-card{display:none;animation:fadeIn .4s ease-out}
.content-card.active{display:block}

/* --- GENERAL CARD STYLE --- */
.info-card{
  background:var(--card);
  padding:25px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  border:1px solid #e0e0e0; /* Th√™m vi·ªÅn nh·∫π */
}

/* --- PROFILE --- */
.profile-card{
  display:flex;gap:30px;align-items:center;
  background:var(--card);padding:30px;border-radius:var(--radius);box-shadow:var(--shadow);
  border-top:5px solid var(--accent-light);
}
.profile-card i{font-size:90px;color:var(--accent);min-width:90px;}
.profile-info p{margin:6px 0;color:var(--text);line-height:1.4}
.profile-info strong{font-weight:600;color:var(--muted)}
.profile-info span{font-weight:500;color:var(--text)}

/* --- SUBJECTS --- */
#subjectCards{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(350px,1fr));
  gap:25px;
  margin-top:10px;
}
.subject-card{
  background:var(--card);padding:25px;border-radius:var(--radius);box-shadow:var(--shadow);
  transition:transform var(--transition), box-shadow var(--transition);
  border-left:6px solid var(--accent);
}
.subject-card:hover{transform:translateY(-5px);box-shadow:0 10px 20px rgba(0,0,0,0.1)}
.subject-card h6{
  margin:0 0 15px 0;color:var(--text);font-size:20px;font-weight:600;
  display:flex;justify-content:space-between;align-items:center;
}
.subject-card h6 span:first-child{color:var(--accent-dark);display:flex;align-items:center;gap:10px;}
.subject-meta{color:var(--muted);font-size:15px;margin-bottom:15px;border-bottom:1px dashed #eee;padding-bottom:10px;}
.class-list{display:flex;flex-wrap:wrap;gap:12px;margin-top:15px}
.class-btn{
  background:var(--accent-light);border:1px solid var(--accent);color:var(--accent-dark);
  padding:10px 18px;border-radius:25px;cursor:pointer;font-size:15px;
  transition:all var(--transition);
  font-weight:600;
}
.class-btn:hover{background:var(--accent);color:#fff;border-color:var(--accent-dark)}
.class-btn:focus-visible{outline:2px solid var(--accent);outline-offset:3px;outline-color:rgba(33,150,243,0.3)}

/* TABLE */
.students-table{width:100%;border-collapse:collapse;border-spacing:0;margin-top:20px;overflow:hidden;border-radius:var(--radius);font-size:15px;}
.students-table th, .students-table td{padding:14px 18px;text-align:left}
.students-table th{background:var(--accent);color:var(--card);font-weight:600;text-transform:uppercase;font-size:13px;letter-spacing:0.5px;border-bottom:2px solid var(--accent-dark)}
.students-table td{border-bottom:1px solid #f0f0f0;background:var(--card)}
.students-table tbody tr:nth-child(even) td{background:#fafafa} /* Zebra stripping */
.students-table tbody tr:hover td{background:var(--accent-light)}
.students-table tbody tr:last-child td{border-bottom:none}
.students-table input{
  width:100px;padding:10px;border-radius:8px;border:1px solid #dbe8ff;text-align:center;
  transition:border-color var(--transition), box-shadow var(--transition);
  font-size:15px;
}
.students-table input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(33,150,243,0.1);}

/* --- SCHEDULE --- */
.schedule-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:25px;margin-top:15px}
.day-column{background:var(--card);padding:22px;border-radius:var(--radius);box-shadow:var(--shadow);border-top:4px solid var(--accent-light);}
.day-column h6{
  text-align:center;margin:0 0 20px 0;color:var(--accent-dark);font-size:18px;font-weight:700;
  border-bottom:2px solid var(--accent-light);padding-bottom:10px;
}
.class-item{
  background:var(--accent-light);
  border-left:5px solid var(--accent);
  padding:15px;
  border-radius:8px;
  margin-bottom:12px;
  font-size:15px;
  color:var(--text);
  box-shadow:0 1px 4px rgba(0,0,0,0.05);
}
.class-item strong{color:var(--accent);font-weight:700;display:block;margin-bottom:2px;}
.class-item .text-muted{font-size:14px;color:var(--muted);line-height:1.4;}

/* --- PASSWORD + BUTTONS --- */
.password-card{max-width:550px;margin:40px auto;background:var(--card);padding:40px;border-radius:var(--radius);box-shadow:var(--shadow);border:1px solid #eee;}
.password-card h5{margin-bottom:25px;font-size:22px;font-weight:700;color:var(--accent)}
.input{
  width:100%;padding:14px 18px;margin-bottom:20px;border-radius:8px;
  border:1px solid #d7e1ef;
  transition:box-shadow var(--transition), border-color var(--transition);
  font-size:16px;
}
.input:focus{box-shadow:0 0 0 4px rgba(33,150,243,0.15);outline:none;border-color:var(--accent)}
.btn{
  background:var(--accent);color:#fff;border:0;padding:12px 24px;border-radius:8px;
  cursor:pointer;font-weight:600;transition:all var(--transition);
  font-size:16px;
}
.btn:hover{
  background: var(--accent-dark);
  transform:translateY(-2px);
  box-shadow:0 4px 10px rgba(33,150,243,0.4);
}
.btn.small{padding:8px 14px;font-size:14px;border-radius:6px;}

/* --- Responsive --- */
@media (max-width:900px){
  .sidebar{
    width:100%;height:auto;position:relative;
    display:flex;flex-direction:row;justify-content:space-between; /* ƒê·ªïi th√†nh space-between */
    padding:10px;box-shadow:0 2px 8px rgba(0,0,0,0.05);
    align-items:center;
  }
  .sidebar h4{display:none}
  .sidebar a{
    padding:8px 6px;margin:0;font-size:11px;gap:5px;flex-direction:column;min-width:65px;text-align:center;
    flex-grow:1; /* Chia ƒë·ªÅu kh√¥ng gian */
  }
  .sidebar a i{font-size:1.5em}
  .sidebar a.active{border-left:none;border-bottom:3px solid var(--accent);padding-bottom:5px;padding-left:6px; background:transparent;} /* Ch·ªâ d√πng border-bottom */
  .sidebar a:hover{background:transparent;}
  
  .main-content{margin-left:0;padding:20px}
  .header{margin-bottom:25px;padding:20px 15px}
  .header h3{font-size:20px}
  
  #subjectCards{grid-template-columns:1fr}
  .schedule-grid{grid-template-columns:1fr}
  .profile-card{flex-direction:column;text-align:center;gap:20px;}
  .password-card{margin:20px 0;max-width:100%;padding:30px;}
}
</style>
</head>
<body>

<div class="sidebar">
  <h4><i class="bi bi-mortarboard-fill"></i> Qu·∫£n l√Ω GV</h4>
  <a href="#" class="active" onclick="toggleSection('profileSection', event)"><i class="bi bi-person"></i> H·ªì s∆°</a>
  <a href="#" onclick="toggleSection('subjectSection', event)"><i class="bi bi-journal-bookmark"></i> M√¥n h·ªçc</a>
  <a href="#" onclick="toggleSection('scheduleSection', event)"><i class="bi bi-calendar-week"></i> TKB</a>
  <a href="#" onclick="toggleSection('passwordSection', event)"><i class="bi bi-lock"></i> M·∫≠t kh·∫©u</a>
</div>

<div class="main-content">
  <div class="header">
    <h3>Ch√†o m·ª´ng, <span id="teacherName">...</span> üëã</h3>
  </div>

  <div id="profileSection" class="content-card active">
    <div class="profile-card">
      <i class="bi bi-person-circle"></i>
      <div class="profile-info">
        <p><strong>M√£ GV:</strong> <span id="teacherCode">-</span></p>
        <p><strong>H·ªç t√™n:</strong> <span id="teacherFullName">-</span></p>
        <p><strong>Email:</strong> <span id="teacherEmail">-</span></p>
      </div>
    </div>
  </div>

  <div id="subjectSection" class="content-card">
    <h4 style="margin-bottom:15px;font-weight:600;color:var(--text)">Danh s√°ch M√¥n gi·∫£ng d·∫°y</h4>
    <div id="subjectCards"></div>
  </div>

  <div id="scheduleSection" class="content-card">
    <h4 style="margin-bottom:15px;font-weight:600;color:var(--text)">Th·ªùi kh√≥a bi·ªÉu</h4>
    <div class="schedule-grid" id="scheduleGrid"></div>
  </div>

  <div id="passwordSection" class="content-card">
    <div class="password-card">
      <h5>ƒê·ªïi m·∫≠t kh·∫©u</h5>
      <input id="oldPassword" class="input" type="password" placeholder="M·∫≠t kh·∫©u c≈©">
      <input id="newPassword" class="input" type="password" placeholder="M·∫≠t kh·∫©u m·ªõi">
      <input id="confirmPassword" class="input" type="password" placeholder="X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi">
      <button class="btn" onclick="changePassword()">X√°c nh·∫≠n</button>
    </div>
  </div>
</div>

<script src="api.js"></script>
<script>
/* Gi·ªØ nguy√™n apiGet/apiPut/apiPost t·ª´ api.js */
const teacherId = localStorage.getItem('teacherId');

window.onload = async function(){
  if(!teacherId){ alert('Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i!'); location.href='login.html'; return; }
  await loadProfile();
  await loadSubjects();
  await loadSchedule();
};

/* PROFILE */
async function loadProfile(){
  try{
    const t = await apiGet(`/teacher/${teacherId}`);
    document.getElementById('teacherName').textContent = t?.fullName ?? '-';
    document.getElementById('teacherFullName').textContent = t?.fullName ?? '-';
    document.getElementById('teacherCode').textContent = t?.teacherCode ?? '-';
    document.getElementById('teacherEmail').textContent = t?.email ?? '-';
  }catch(err){
    console.error('loadProfile', err);
    alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c th√¥ng tin gi√°o vi√™n.');
  }
}

/* SUBJECTS: dedupe v√† hi·ªÉn th·ªã c√°c l·ªõp */
async function loadSubjects(){
  try{
    const raw = await apiGet(`/teacher/subjectsOfTeacher/${teacherId}`);
    const container = document.getElementById('subjectCards');
    if(!Array.isArray(raw) || raw.length===0){
      container.innerHTML = `<div class="info-card">Kh√¥ng c√≥ m√¥n n√†o.</div>`;
      return;
    }
    const map = new Map();
    raw.forEach(item=>{
      const id = item.id ?? item.subjectId ?? (item.subject && item.subject.id) ?? null;
      const name = item.subjectName ?? item.name ?? (item.subject && item.subject.name) ?? 'Kh√¥ng t√™n';
      const key = id != null ? String(id) : `name:${name}`;
      if(!map.has(key)) map.set(key, { id, name });
    });
    const subs = Array.from(map.values());
    container.innerHTML = subs.map(s=>`
      <div class="subject-card" data-subjectid="${s.id}">
        <h6>
          <span><i class="bi bi-book-half"></i> ${escapeHtml(s.name)}</span>
          <span style="font-size:12px;color:var(--muted)">ID: ${s.id ?? '-'}</span>
        </h6>
        <div class="subject-meta">Ch·ªçn l·ªõp ƒë·ªÉ xem sinh vi√™n v√† ƒëi·ªÉm</div>
        <div class="subject-actions">
          <button class="btn small btn-load-classes" data-subjectid="${s.id}" data-subjectname="${escapeAttr(s.name)}">Xem l·ªõp</button>
        </div>
        <div class="class-list" style="display:none;"></div>
        <div class="students-area" style="margin-top:20px; display:none;"></div>
      </div>
    `).join('');

    // attach handler
    container.querySelectorAll('.btn-load-classes').forEach(btn=>{
      btn.addEventListener('click', async (ev)=>{
        const subjId = btn.dataset.subjectid;
        const card = btn.closest('.subject-card');
        const classListEl = card.querySelector('.class-list');
        const studentsArea = card.querySelector('.students-area');
        
        // Toggle visibility
        const isVisible = classListEl.style.display === 'flex';
        // Reset display for all other cards
        container.querySelectorAll('.subject-card').forEach(c => {
          if (c !== card) {
            c.querySelector('.class-list').style.display = 'none';
            c.querySelector('.students-area').style.display = 'none';
          }
        });

        if(isVisible){ 
          classListEl.style.display='none'; 
          studentsArea.style.display='none'; 
          return; 
        }

        classListEl.style.display = 'flex';
        classListEl.innerHTML = '<div style="color:var(--muted)">ƒêang t·∫£i l·ªõp...</div>';
        studentsArea.style.display = 'none';
        
        try{
          const classes = await apiGet(`/teacher/classesOfSubject/${subjId}`);
          if(!Array.isArray(classes) || classes.length===0){ classListEl.innerHTML = `<div class="text-muted">Kh√¥ng c√≥ l·ªõp cho m√¥n n√†y</div>`; return; }
          classListEl.innerHTML = classes.map(c=>{
            const cstId = c.id ?? c.classSubjectTeacherId ?? c.cstId ?? '';
            const classId = c.classId ?? (c.schoolClass && c.schoolClass.id) ?? '';
            const className = c.className ?? (c.schoolClass && c.schoolClass.name) ?? `L·ªõp ${classId || cstId}`;
            return `<button class="class-btn" data-subjectid="${subjId}" data-cstid="${cstId}" data-classid="${classId}" data-classname="${escapeAttr(className)}">${escapeHtml(className)}</button>`;
          }).join('');
          // attach per-class handlers
          classListEl.querySelectorAll('.class-btn').forEach(cb=>{
            cb.addEventListener('click', async (e)=>{
              // Highlight active class button
              classListEl.querySelectorAll('.class-btn').forEach(b=>b.style.backgroundColor='var(--accent-light)');
              e.currentTarget.style.backgroundColor = 'var(--accent)';
              e.currentTarget.style.color = 'white';

              const subjId = e.currentTarget.dataset.subjectid;
              const cstId = e.currentTarget.dataset.cstid;
              const classId = e.currentTarget.dataset.classid;
              const className = e.currentTarget.dataset.classname;
              await loadStudentsIntoCard(subjId, classId, cstId, className, card);
            });
          });
        }catch(err){
          console.error('load classes', err);
          classListEl.innerHTML = `<div class="text-muted">L·ªói t·∫£i l·ªõp</div>`;
        }
      });
    });

  }catch(err){
    console.error('loadSubjects', err);
    alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch m√¥n.');
  }
}

/* load students for chosen class only; merge grades from enrollments (if any) */
async function loadStudentsIntoCard(subjectId, classId, cstId, className, cardElement){
  const studentsArea = cardElement.querySelector('.students-area');
  studentsArea.style.display='block';
  studentsArea.innerHTML = `<div style="color:var(--muted);padding:10px;">ƒêang t·∫£i sinh vi√™n...</div>`;

  try{
    let students = [];
    // 1) Prefer studentsOfClass when classId present
    if(classId){
      try{
        const studs = await apiGet(`/teacher/studentsOfClass/${classId}`);
        if(Array.isArray(studs) && studs.length>0){
          students = studs.map(s=>{
            return {
              studentId: s.id ?? s.studentId ?? '',
              studentCode: s.studentCode ?? s.code ?? '',
              fullName: s.fullName ?? s.name ?? '',
              grade: s.grade ?? null
            };
          });
        }
      }catch(e){
        console.warn('studentsOfClass failed, will try fallback to enrollments', e);
        students = [];
      }
    }

    // 2) If no students from studentsOfClass (classId not provided or endpoint empty), fallback to enrollments and filter by cstId
    if((!students || students.length===0)){
      const enroll = await apiGet(`/teacher/subjects/${subjectId}/students`);
      if(Array.isArray(enroll) && enroll.length>0){
        // If cstId present, filter by cstId; otherwise keep all enrollments for subject
        let filtered = enroll;
        if(cstId){
          filtered = enroll.filter(en => {
            const enCst = en.cstId ?? en.classSubjectTeacherId ?? en.cst ?? null;
            if(enCst) return String(enCst) === String(cstId);
            // try classId inside enrollment if available
            const eClassId = en.classId ?? en.schoolClassId ?? en.class?.id ?? en.schoolClass?.id ?? null;
            if(classId && eClassId) return String(eClassId) === String(classId);
            return false;
          });
        }
        students = filtered.map(en=>{
          const sid = en.studentId ?? en.student?.id ?? en.id ?? '';
          const code = en.studentCode ?? en.student?.studentCode ?? en.student?.code ?? '';
          const name = en.studentName ?? en.student?.fullName ?? en.student?.name ?? '';
          const grade = (en.grade===0 || en.grade) ? en.grade : (en.point ?? en.score ?? null);
          return { studentId: sid, studentCode: code, fullName: name, grade };
        });
      }
    }

    // 3) additionally: try to merge grades: call enrollments and create map by studentId + cstId
    let enrollMap = new Map();
    try{
      const enrollAll = await apiGet(`/teacher/subjects/${subjectId}/students`);
      if(Array.isArray(enrollAll)){
        enrollAll.forEach(en => {
          const sid = en.studentId ?? en.student?.id ?? en.id ?? null;
          const enCst = en.cstId ?? en.classSubjectTeacherId ?? en.cst ?? null;
          if(sid != null){
            enrollMap.set(String(sid) + '::' + String(enCst ?? ''), {
              grade: (en.grade===0 || en.grade) ? en.grade : (en.point ?? en.score ?? null),
              cstId: enCst
            });
            // also map by sid only (if no cst match)
            if(!enrollMap.has(String(sid) + '::')) enrollMap.set(String(sid) + '::', {
              grade: (en.grade===0 || en.grade) ? en.grade : (en.point ?? en.score ?? null),
              cstId: enCst
            });
          }
        });
      }
    }catch(e){
      // ignore if fails
    }

    // merge grades into students array
    students = (students || []).map(s => {
      const sid = String(s.studentId ?? '');
      let g = s.grade ?? '';
      // prefer exact cst match
      const keyExact = sid + '::' + String(cstId ?? '');
      if(enrollMap.has(keyExact) && enrollMap.get(keyExact).grade !== null && enrollMap.get(keyExact).grade !== undefined){
        g = enrollMap.get(keyExact).grade;
      } else if(enrollMap.has(sid + '::') && (g === '' || g === null || g === undefined)){
        g = enrollMap.get(sid + '::').grade;
      }
      return {...s, grade: g};
    });

    // render
    if(!students || students.length===0){
      studentsArea.innerHTML = `<div style="color:var(--muted);padding:10px;">Kh√¥ng c√≥ sinh vi√™n trong l·ªõp ${className}.</div>`;
      return;
    }

    studentsArea.innerHTML = `
      <h6 style="font-size:16px; margin-bottom:10px; color:var(--text); border-bottom:1px solid #ebf1f5; padding-bottom:5px;">Sinh vi√™n l·ªõp: ${escapeHtml(className)}</h6>
      <table class="students-table">
        <thead><tr><th style="width:15%">M√£ SV</th><th>T√™n</th><th style="width:15%">ƒêi·ªÉm</th><th style="width:18%">H√†nh ƒë·ªông</th></tr></thead>
        <tbody>
          ${students.map(st => `
            <tr data-studentid="${escapeHtml(st.studentId)}" data-cstid="${escapeHtml(cstId)}">
              <td>${escapeHtml(st.studentCode)}</td>
              <td>${escapeHtml(st.fullName)}</td>
              <td><input id="grade-${escapeHtml(st.studentId)}" type="number" step="0.1" min="0" max="10" value="${(st.grade !== null && st.grade !== undefined && st.grade !== '') ? st.grade : ''}"></td>
              <td><button class="btn small" data-studentid="${escapeAttr(st.studentId)}" data-cstid="${escapeAttr(cstId)}" onclick="saveGradeInline(this)">L∆∞u</button></td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;

  }catch(err){
    console.error('loadStudentsIntoCard', err);
    studentsArea.innerHTML = `<div style="color:var(--muted);padding:10px;">L·ªói t·∫£i sinh vi√™n.</div>`;
  }
}

/* inline save grade */
async function saveGradeInline(btn){
  const tr = btn.closest('tr');
  const studentId = btn.dataset.studentid ?? tr.dataset.studentid;
  const cstId = btn.dataset.cstid ?? tr.dataset.cstId;
  if(!studentId) return alert('Kh√¥ng bi·∫øt studentId');
  if(!cstId) return alert('Thi·∫øu cstId ƒë·ªÉ l∆∞u ƒëi·ªÉm (vui l√≤ng ki·ªÉm tra endpoint backend).');
  const input = document.getElementById(`grade-${studentId}`);
  if(!input) return alert('Kh√¥ng t√¨m th·∫•y √¥ ƒëi·ªÉm');
  const val = input.value;
  if(val === '') return alert('Vui l√≤ng nh·∫≠p ƒëi·ªÉm');
  const num = Number(val);
  if(Number.isNaN(num) || num < 0 || num > 10) return alert('ƒêi·ªÉm ph·∫£i t·ª´ 0 ƒë·∫øn 10');
  
  btn.textContent = 'ƒêang l∆∞u...';
  btn.disabled = true;

  try{
    // API endpoint: PUT /teacher/subjects/{cstId}/students/{studentId}/{grade}
    await apiPut(`/teacher/subjects/${cstId}/students/${studentId}/${num}`);
    alert('C·∫≠p nh·∫≠t ƒëi·ªÉm th√†nh c√¥ng');
  }catch(err){
    console.error('saveGradeInline', err);
    alert('L·ªói khi l∆∞u ƒëi·ªÉm. Xem console.');
  }finally{
    btn.textContent = 'L∆∞u';
    btn.disabled = false;
  }
}

/* SCHEDULE */
async function loadSchedule(){
  try{
    const list = await apiGet(`/teacher/teachers/${teacherId}/schedules`);
    const days = [
      { name: "Th·ª© 2", code: 2 },
      { name: "Th·ª© 3", code: 3 },
      { name: "Th·ª© 4", code: 4 },
      { name: "Th·ª© 5", code: 5 },
      { name: "Th·ª© 6", code: 6 },
      { name: "Th·ª© 7", code: 7 }
    ];
    const container = document.getElementById('scheduleGrid');
    container.innerHTML = days.map(day=>{
      const subjects = (Array.isArray(list) ? list : []).filter(s => Number(s.dayOfWeek) === day.code);
      // Sort subjects by period (assuming period is a number)
      subjects.sort((a, b) => (a.period ?? 0) - (b.period ?? 0));
      
      return `<div class="day-column"><h6>${day.name}</h6>` +
        (subjects.length ? subjects.map(s=>`
          <div class="class-item">
            <strong>${escapeHtml(s.subjectName ?? s.subject?.name ?? '')}</strong>
            <div class="text-muted">L·ªõp: ${escapeHtml(s.className ?? s.class?.name ?? '')}</div>
            <div class="text-muted">Ti·∫øt: ${escapeHtml(String(s.period ?? ''))}</div>
          </div>`).join('') : `<p class="text-muted" style="text-align:center;margin-top:12px;font-size:14px;">Kh√¥ng c√≥ ti·∫øt</p>`)
        + `</div>`;
    }).join('');
  }catch(err){
    console.error('loadSchedule', err);
    document.getElementById('scheduleGrid').innerHTML = `<div class="info-card" style="grid-column: 1 / -1; color:var(--muted)">L·ªói t·∫£i th·ªùi kh√≥a bi·ªÉu.</div>`;
  }
}

/* CHANGE PASSWORD */
async function changePassword(){
  const oldPass = document.getElementById('oldPassword').value.trim();
  const newPass = document.getElementById('newPassword').value.trim();
  const confirmPass = document.getElementById('confirmPassword').value.trim();
  if(newPass !== confirmPass) return alert('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!');
  if(!oldPass || !newPass) return alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß!');
  if(newPass.length < 6) return alert('M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±.');
  
  const btn = document.querySelector('#passwordSection .btn');
  btn.textContent = 'ƒêang x·ª≠ l√Ω...';
  btn.disabled = true;
  
  try{
    await apiPost('/teacher/change-password', { oldPassword: oldPass, newPassword: newPass, userId: teacherId });
    alert('ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng! Vui l√≤ng s·ª≠ d·ª•ng m·∫≠t kh·∫©u m·ªõi cho l·∫ßn ƒëƒÉng nh·∫≠p sau.');
    document.getElementById('oldPassword').value='';
    document.getElementById('newPassword').value='';
    document.getElementById('confirmPassword').value='';
  }catch(err){
    console.error('changePassword', err);
    alert('L·ªói ƒë·ªïi m·∫≠t kh·∫©u. C√≥ th·ªÉ m·∫≠t kh·∫©u c≈© kh√¥ng ƒë√∫ng. Xem console ƒë·ªÉ bi·∫øt chi ti·∫øt.');
  }finally{
    btn.textContent = 'X√°c nh·∫≠n';
    btn.disabled = false;
  }
}

/* UI helpers */
function toggleSection(id, event){
  document.querySelectorAll('.content-card').forEach(sec => sec.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  document.querySelectorAll('.sidebar a').forEach(a=>a.classList.remove('active'));
  if(event && event.target){
    const a = event.target.closest('a');
    if(a) a.classList.add('active');
  }
}
function escapeHtml(str){
  if(str === null || str === undefined) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
function escapeAttr(s){ return String(s ?? '').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
function decodeAttr(s){ return String(s||'').replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&amp;/g,'&'); }
</script>
</body>
</html>